<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <!-- Hereda el reporte Delivery Slip de stock -->
  <template id="stock_transfer_charge_report_template"
            inherit_id="stock.report_deliveryslip">
    <!-- Inserta la sección de Cargos entre Locales tras la Guía de Despacho -->
    <xpath expr="//t[@t-call='stock.report_delivery_document']" position="after">
      <!-- Nueva página para cargos -->
      <div class="page break-after mt32">
        <t t-foreach="docs" t-as="o">
          <h2 style="text-align:center;">Cargos entre Locales — <small><t t-esc="o.name"/></small></h2>
          <table class="table table-sm mt16">
            <thead>
              <tr>
                <th>Mes</th>
                <th>Taller Origen</th>
                <th>Taller Destino</th>
                <th class="text-right">Total (CLP)</th>
              </tr>
            </thead>
            <tbody>
              <t t-foreach="charge_lines" t-as="c">
                <!-- Filtrar solo cargos de este picking -->
                <t t-if="c['picking_id'] == o.id">
                  <tr>
                    <td><t t-esc="c['month']"/></td>
                    <td><t t-esc="c['origin']"/></td>
                    <td><t t-esc="c['dest']"/></td>
                    <td class="text-right"><t t-esc="'%.2f' % c['amount']"/></td>
                  </tr>
                </t>
              </t>
              <t t-if="not any(c['picking_id']==o.id for c in charge_lines)">
                <tr>
                  <td colspan="4" class="text-center"><em>No hay cargos para este picking.</em></td>
                </tr>
              </t>
            </tbody>
          </table>
        </t>
      </div>
    </xpath>
  </template>
</odoo>
